version: "1.1"

# Quality gates configuration for Issue #251
# Scope: static analysis gates only (0-4b)
# Tests/coverage are executed via run_tests, not via run_quality_gates
active_gates:
  - gate0_ruff_format
  - gate1_formatting
  - gate2_imports
  - gate3_line_length
  - gate4_types
  - gate4_pyright

artifact_logging:
  enabled: true
  output_dir: "mcp_server/logs/qa_logs"
  max_files: 200

project_scope:
  include_globs:
    - "mcp_server/**/*.py"
    - "tests/mcp_server/**/*.py"

gates:
  gate0_ruff_format:
    name: "Gate 0: Ruff Format"
    description: "Code formatting (ruff format --check)"
    execution:
      command: ["python", "-m", "ruff", "format", "--check", "--diff", "--isolated", "--line-length=100"]
      timeout_seconds: 60
      working_dir: null
    success:
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: true
      parsing_strategy: "text_violations"
      text_violations:
        pattern: "^--- (?P<file>.+)$"
        severity_default: "error"
        defaults:
          rule: "FORMAT"
          message: "File requires formatting"

  gate1_formatting:
    name: "Gate 1: Ruff Strict Lint"
    description: "Strict linting (stricter than VS Code/IDE baseline)"
    execution:
      command:
        [
          "python",
          "-m",
          "ruff",
          "check",
          "--isolated",
          "--output-format=json",
          "--select=E,W,F,I,N,UP,ANN,B,C4,DTZ,T10,ISC,RET,SIM,ARG,PLC",
          "--ignore=E501,PLC0415",
          "--line-length=100",
          "--target-version=py311"
        ]
      timeout_seconds: 60
      working_dir: null
    success:
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: true
      parsing_strategy: "json_violations"
      json_violations:
        violations_path: null
        field_map:
          file: "filename"
          line: "location/row"
          col: "location/column"
          rule: "code"
          message: "message"
        fixable_when: "fix/applicability"

  gate2_imports:
    name: "Gate 2: Imports"
    description: "Import placement (no imports outside top-level)"
    execution:
      command:
        [
          "python",
          "-m",
          "ruff",
          "check",
          "--isolated",
          "--output-format=json",
          "--select=PLC0415",
          "--target-version=py311"
        ]
      timeout_seconds: 60
      working_dir: null
    success:
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false
      parsing_strategy: "json_violations"
      json_violations:
        violations_path: null
        field_map:
          file: "filename"
          line: "location/row"
          col: "location/column"
          rule: "code"
          message: "message"
        fixable_when: "fix/applicability"

  gate3_line_length:
    name: "Gate 3: Line Length"
    description: "Line length (max 100 characters)"
    execution:
      command:
        [
          "python",
          "-m",
          "ruff",
          "check",
          "--isolated",
          "--output-format=json",
          "--select=E501",
          "--line-length=100",
          "--target-version=py311"
        ]
      timeout_seconds: 60
      working_dir: null
    success:
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false
      parsing_strategy: "json_violations"
      json_violations:
        violations_path: null
        field_map:
          file: "filename"
          line: "location/row"
          col: "location/column"
          rule: "code"
          message: "message"
        fixable_when: "fix/applicability"

  gate4_types:
    name: "Gate 4: Types"
    description: "Type checking (strict mode for DTOs)"
    execution:
      command: ["python", "-m", "mypy", "--strict", "--no-error-summary"]
      timeout_seconds: 60
      working_dir: null
    success:
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false
      parsing_strategy: "text_violations"
      text_violations:
        pattern: '^(?P<file>[^:]+):(?P<line>\d+): (?P<severity>error|warning|note): (?P<message>.+?)(?:\s+\[(?P<rule>[^\]]+)\])?$'
        severity_default: "error"
        defaults: {}
    scope:
      include_globs:
        - "backend/dtos/**/*.py"
      exclude_globs:
        - "tests/**/*.py"

  gate4_pyright:
    name: "Gate 4b: Pyright"
    description: "Type checking (Pyright strict; warnings fail)"
    execution:
      command:
        [
          "python",
          "-m",
          "pyright",
          "--project",
          "pyrightconfig.json",
          "--pythonversion",
          "3.11",
          "--pythonplatform",
          "Windows",
          "--level",
          "warning",
          "--warnings",
          "--outputjson"
        ]
      timeout_seconds: 120
      working_dir: null
    success:
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false
      parsing_strategy: "json_violations"
      json_violations:
        violations_path: "generalDiagnostics"
        field_map:
          file: "file"
          line: "range/start/line"
          col: "range/start/character"
          message: "message"
          rule: "rule"
          severity: "severity"
        line_offset: 1

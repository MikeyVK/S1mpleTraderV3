version: "1.0"

# Active quality gates for CI/CD enforcement
# Updated for Issue #131: Ruff replaces Pylint for gates 1-3
active_gates:
  - gate1_formatting
  - gate2_imports
  - gate3_line_length
  - gate4_types
  - gate5_tests

gates:
  # Gate 1: Code Formatting (Ruff replaces Pylint)
  gate1_formatting:
    name: "Gate 1: Formatting"
    description: "Code formatting (trailing whitespace, superfluous parentheses)"
    execution:
      command: ["python", "-m", "ruff", "check", "--select=W291,W292,W293,UP034", "--ignore="]
      timeout_seconds: 60
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: true
      produces_json: false

  # Gate 2: Import Placement (Ruff replaces Pylint)
  gate2_imports:
    name: "Gate 2: Imports"
    description: "Import placement (no imports outside top-level)"
    execution:
      command: ["python", "-m", "ruff", "check", "--select=PLC0415", "--ignore="]
      timeout_seconds: 60
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false
      produces_json: false

  # Gate 3: Line Length (Ruff replaces Pylint)
  gate3_line_length:
    name: "Gate 3: Line Length"
    description: "Line length (max 100 characters)"
    execution:
      command: ["python", "-m", "ruff", "check", "--select=E501", "--line-length=100", "--ignore="]
      timeout_seconds: 60
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false
      produces_json: false

  # Gate 4: Type Checking (Mypy strict for DTOs only)
  gate4_types:
    name: "Gate 4: Types"
    description: "Type checking (strict mode for DTOs)"
    execution:
      command: ["python", "-m", "mypy", "--strict", "--no-error-summary"]
      timeout_seconds: 60
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false
      produces_json: false
    scope:
      include_globs:
        - "backend/dtos/**/*.py"
      exclude_globs:
        - "tests/**/*.py"

  # Gate 5: Unit Tests (Pytest)
  gate5_tests:
    name: "Gate 5: Tests"
    description: "Unit tests (all passing)"
    execution:
      command: ["pytest", "tests/", "--tb=short"]
      timeout_seconds: 300
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false
      produces_json: false

  # === LEGACY GATES (Deprecated - kept for reference) ===

  pylint:
    name: "Linting"
    description: "Python linting"
    execution:
      command: ["python", "-m", "pylint", "--enable=all", "--disable=duplicate-code,redefined-outer-name", "--max-line-length=100", "--output-format=text"]
      timeout_seconds: 60
      working_dir: null
    parsing:
      strategy: "text_regex"
      patterns:
        - name: "rating"
          regex: "Your code has been rated at ([\\d.]+)/10"
          flags: ["MULTILINE"]
          group: 1
          required: true
    success:
      mode: "text_regex"
      min_score: 10.0
      require_no_issues: true
    capabilities:
      file_types: [".py"]
      supports_autofix: false
      produces_json: false

  pyright:
    name: "Pyright"
    description: "Type checking"
    execution:
      command: ["python", "-m", "pyright", "--project", "pyrightconfig.json", "--outputjson"]
      timeout_seconds: 120
      working_dir: null
    parsing:
      strategy: "json_field"
      fields:
        diagnostics: "/generalDiagnostics"
        error_count: "/summary/errorCount"
      diagnostics_path: "/generalDiagnostics"
    success:
      mode: "json_field"
      max_errors: 0
      require_no_issues: true
    capabilities:
      file_types: [".py"]
      supports_autofix: false
      produces_json: true

  ruff:
    name: "Ruff"
    description: "Fast linter"
    execution:
      command: ["ruff", "check"]
      timeout_seconds: 60
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: true
      produces_json: false

  black:
    name: "Black"
    description: "Python formatting (check mode)"
    execution:
      command: ["black", "--check", "."]
      timeout_seconds: 60
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: true
      produces_json: false

  mypy:
    name: "Type Checking"
    description: "Static type checking"
    execution:
      command: ["python", "-m", "mypy", "--strict", "--no-error-summary"]
      timeout_seconds: 60
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false
      produces_json: false
    scope:
      include_globs:
        - "backend/**/*.py"
        - "mcp_server/**/*.py"
      exclude_globs:
        - "tests/**/*.py"

  pytest:
    name: "Pytest"
    description: "Unit tests"
    execution:
      command: ["pytest", "tests/"]
      timeout_seconds: 300
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false
      produces_json: false

  bandit:
    name: "Bandit"
    description: "Python security linting"
    execution:
      command: ["bandit", "-r", "."]
      timeout_seconds: 120
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false
      produces_json: false

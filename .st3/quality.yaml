version: "1.0"

# Active quality gates for CI/CD enforcement
# Updated for Issue #131: Ruff replaces Pylint for gates 1-3
# Gate 6 added: Coverage enforcement (branch >= 90%)
active_gates:
  - gate0_ruff_format
  - gate1_formatting
  - gate2_imports
  - gate3_line_length
  - gate4_types
  - gate4_pyright

artifact_logging:
  enabled: true
  output_dir: "mcp_server/logs/qa_logs"
  max_files: 200

gates:
  # Gate 0: Formatter (Ruff)
  gate0_ruff_format:
    name: "Gate 0: Ruff Format"
    description: "Code formatting (ruff format --check)"
    execution:
      command: ["python", "-m", "ruff", "format", "--check", "--diff", "--isolated", "--line-length=100"]
      timeout_seconds: 60
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: true

  # Gate 1: Strict Lint (Ruff, stricter than IDE)
  gate1_formatting:
    name: "Gate 1: Ruff Strict Lint"
    description: "Strict linting (stricter than VS Code/IDE baseline)"
    execution:
      command:
        [
          "python",
          "-m",
          "ruff",
          "check",
          "--isolated",
          "--output-format=json",
          "--select=E,W,F,I,N,UP,ANN,B,C4,DTZ,T10,ISC,RET,SIM,ARG,PLC",
          "--ignore=E501,PLC0415",
          "--line-length=100",
          "--target-version=py311"
        ]
      timeout_seconds: 60
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: true

  # Gate 2: Import Placement (Ruff replaces Pylint)
  gate2_imports:
    name: "Gate 2: Imports"
    description: "Import placement (no imports outside top-level)"
    execution:
      command:
        [
          "python",
          "-m",
          "ruff",
          "check",
          "--isolated",
          "--output-format=json",
          "--select=PLC0415",
          "--target-version=py311"
        ]
      timeout_seconds: 60
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false

  # Gate 3: Line Length (Ruff replaces Pylint)
  gate3_line_length:
    name: "Gate 3: Line Length"
    description: "Line length (max 100 characters)"
    execution:
      command:
        [
          "python",
          "-m",
          "ruff",
          "check",
          "--isolated",
          "--output-format=json",
          "--select=E501",
          "--line-length=100",
          "--target-version=py311"
        ]
      timeout_seconds: 60
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false

  # Gate 4: Type Checking (Mypy strict for DTOs only)
  gate4_types:
    name: "Gate 4: Types"
    description: "Type checking (strict mode for DTOs)"
    execution:
      command: ["python", "-m", "mypy", "--strict", "--no-error-summary"]
      timeout_seconds: 60
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false
    scope:
      include_globs:
        - "backend/dtos/**/*.py"
      exclude_globs:
        - "tests/**/*.py"
  # Gate 4b: Type Checking (Pyright)
  gate4_pyright:
    name: "Gate 4b: Pyright"
    description: "Type checking (Pyright strict; warnings fail)"
    execution:
      command:
        [
          "python",
          "-m",
          "pyright",
          "--project",
          "pyrightconfig.json",
          "--pythonversion",
          "3.11",
          "--pythonplatform",
          "Windows",
          "--level",
          "warning",
          "--warnings",
          "--outputjson"
        ]
      timeout_seconds: 120
      working_dir: null
    parsing:
      strategy: "json_field"
      fields:
        diagnostics: "/generalDiagnostics"
        error_count: "/summary/errorCount"
      diagnostics_path: "/generalDiagnostics"
    success:
      mode: "json_field"
      max_errors: 0
      require_no_issues: true
    capabilities:
      file_types: [".py"]
      supports_autofix: false

  # Gate 5: Unit Tests (Pytest)
  gate5_tests:
    name: "Gate 5: Tests"
    description: "Unit tests (all passing)"
    execution:
      command: ["pytest", "tests/", "--tb=short"]
      timeout_seconds: 300
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false

  # Gate 6: Code Coverage (Pytest + Coverage)
  gate6_coverage:
    name: "Gate 6: Coverage"
    description: "Branch coverage >= 90% (backend + mcp_server)"
    execution:
      command: ["pytest", "tests/", "--cov=backend", "--cov=mcp_server", "--cov-branch", "--cov-fail-under=90", "--tb=short"]
      timeout_seconds: 300
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false

  # === LEGACY GATES (Deprecated - kept for reference) ===

  ruff:
    name: "Ruff"
    description: "Fast linter"
    execution:
      command: ["ruff", "check"]
      timeout_seconds: 60
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: true

  black:
    name: "Black"
    description: "Python formatting (check mode)"
    execution:
      command: ["black", "--check", "."]
      timeout_seconds: 60
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: true

  mypy:
    name: "Type Checking"
    description: "Static type checking"
    execution:
      command: ["python", "-m", "mypy", "--strict", "--no-error-summary"]
      timeout_seconds: 60
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false
    scope:
      include_globs:
        - "backend/**/*.py"
        - "mcp_server/**/*.py"
      exclude_globs:
        - "tests/**/*.py"

  pytest:
    name: "Pytest"
    description: "Unit tests"
    execution:
      command: ["pytest", "tests/"]
      timeout_seconds: 300
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false

  bandit:
    name: "Bandit"
    description: "Python security linting"
    execution:
      command: ["bandit", "-r", "."]
      timeout_seconds: 120
      working_dir: null
    parsing:
      strategy: "exit_code"
    success:
      mode: "exit_code"
      exit_codes_ok: [0]
    capabilities:
      file_types: [".py"]
      supports_autofix: false

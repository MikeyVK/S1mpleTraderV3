# GitHub Copilot Instructions

**Auto-loaded by VS Code** ‚Äî This file contains the complete operational protocol for the S1mpleTrader V3 project.

**Full Reference:** [agent.md](../agent.md) in workspace root contains extended documentation and examples. This file is the **source of truth** for critical rules.

---

## üîß Tool Priority Matrix (MANDATORY)

**Never use `run_in_terminal` for these operations ‚Äî use MCP tools instead:**

### Git Operations
| Action | ‚úÖ USE THIS | ‚ùå NEVER USE |
|--------|-------------|------------|
| Create branch | `create_branch(name, base_branch, branch_type)` | `run_in_terminal("git branch")` |
| Commit | `git_add_or_commit(phase, message)` | `run_in_terminal("git commit")` |
| Checkout | `git_checkout(branch)` | `run_in_terminal("git checkout")` |
| Push | `git_push(set_upstream)` | `run_in_terminal("git push")` |
| Merge | `git_merge(branch)` | `run_in_terminal("git merge")` |
| Delete branch | `git_delete_branch(branch, force)` | `run_in_terminal("git branch -d")` |
| Stash | `git_stash(action, message)` | `run_in_terminal("git stash")` |
| Status | `git_status()` | `run_in_terminal("git status")` |
| Restore | `git_restore(files, source)` | `run_in_terminal("git restore")` |
| Fetch | `git_fetch(remote, prune)` | `run_in_terminal("git fetch")` |
| Pull | `git_pull(remote, rebase)` | `run_in_terminal("git pull")` |
| List branches | `git_list_branches(verbose, remote)` | `run_in_terminal("git branch -a")` |
| Diff stats | `git_diff_stat(target_branch, source_branch)` | `run_in_terminal("git diff --stat")` |

### GitHub Operations
| Action | ‚úÖ USE THIS | ‚ùå NEVER USE |
|--------|-------------|------------|
| Create issue | `create_issue(title, body, labels, milestone, assignees)` | `run_in_terminal("gh issue create")` |
| Get issue | `get_issue(issue_number)` | `run_in_terminal("gh issue view")` |
| List issues | `list_issues(state, labels)` | `run_in_terminal("gh issue list")` |
| Update issue | `update_issue(issue_number, ...)` | `run_in_terminal("gh issue edit")` |
| Close issue | `close_issue(issue_number, comment)` | `run_in_terminal("gh issue close")` |
| Create PR | `create_pr(title, body, head, base, draft)` | `run_in_terminal("gh pr create")` |
| List PRs | `list_prs(state, base, head)` | `run_in_terminal("gh pr list")` |
| Merge PR | `merge_pr(pr_number, commit_message, merge_method)` | `run_in_terminal("gh pr merge")` |
| Create label | `create_label(name, color, description)` | Manual GitHub UI |
| Add labels | `add_labels(issue_number, labels)` | `run_in_terminal("gh issue edit")` |
| Create milestone | `create_milestone(title, description, due_on)` | Manual GitHub UI |

### File Operations
| Action | ‚úÖ USE THIS | ‚ùå NEVER USE |
|--------|-------------|------------|
| Edit file | `safe_edit_file(path, content/line_edits/insert_lines/search+replace, mode)` | `run_in_terminal("Set-Content")` |
| Scaffold code/docs | `scaffold_artifact(artifact_type, name, context)` | `create_file` or manual creation |

### Quality & Testing
| Action | ‚úÖ USE THIS | ‚ùå NEVER USE |
|--------|-------------|------------|
| Run quality gates | `run_quality_gates(files)` | `run_in_terminal("pylint")` or `run_in_terminal("mypy")` |
| Run tests | `run_tests(path, markers, timeout, verbose)` | `run_in_terminal("pytest")` |
| Validate architecture | `validate_architecture(scope)` | Manual review |
| Validate DTO | `validate_dto(file_path)` | Manual review |
| Validate template | `validate_template(path, template_type)` | Manual review |

### Project & Phase Management
| Action | ‚úÖ USE THIS | ‚ùå NEVER USE |
|--------|-------------|------------|
| Initialize project | `initialize_project(issue_number, issue_title, workflow_name)` | Manual .st3/ file creation |
| Get project plan | `get_project_plan(issue_number)` | Manual .st3/ file reading |
| Transition phase | `transition_phase(branch, to_phase)` | Manual .st3/state.json edit |
| Force phase transition | `force_phase_transition(branch, to_phase, skip_reason, human_approval)` | Manual .st3/state.json edit |

### Discovery & Admin
| Action | ‚úÖ USE THIS | ‚ùå NEVER USE |
|--------|-------------|------------|
| Search docs | `search_documentation(query, scope)` | `grep_search` on docs/ |
| Get work context | `get_work_context(include_closed_recent)` | Manual file reading |
| Health check | `health_check()` | N/A |
| Restart server | `restart_server(reason)` | Process kill |

---

## üö´ run_in_terminal Restrictions (CRITICAL)

**`run_in_terminal` is ONLY allowed for:**

‚úÖ **Permitted (rare cases):**
- Development servers where no MCP tool exists (e.g., `npm run dev`, `python -m http.server`)
- Build commands explicitly requested by user
- Smoke tests / exploratory commands approved by user
- Python package installations via pip (when not using install_python_packages tool)

‚ùå **FORBIDDEN (use MCP tool instead):**
- **File operations** ‚Üí use `safe_edit_file` / `scaffold_artifact`
- **Git operations** ‚Üí use `git_*` tools (see matrix above)
- **Test execution** ‚Üí use `run_tests` tool
- **Quality gates** ‚Üí use `run_quality_gates` tool

**Default rule: If unsure, ask yourself "Is there an MCP tool for this?" If yes ‚Üí use it. If no ‚Üí ask user permission first.**

---

## üî¥ TDD Cycle (RED ‚Üí GREEN ‚Üí REFACTOR)

**Strict protocol ‚Äî never skip steps:**

1. **RED Phase:** Write failing test FIRST
   - Commit: `git_add_or_commit(phase="red", message="Add failing test for X")`
   - Verify test fails: `run_tests(path="...")`

2. **GREEN Phase:** Implement minimal code to pass test
   - Commit: `git_add_or_commit(phase="green", message="Implement X")`
   - Verify test passes: `run_tests(path="...")`

3. **REFACTOR Phase:** Improve code while keeping tests green
   - Commit: `git_add_or_commit(phase="refactor", message="Refactor X")`
   - Verify tests still pass: `run_tests(path="...")`

4. **DOCS Phase:** Update documentation
   - Commit: `git_add_or_commit(phase="docs", message="Document X")`

**Quality Gates:** Run `run_quality_gates(files=[...])` before phase transitions and before PR creation.

---

## ‚öñÔ∏è Prime Directives (The "7 Laws")

1. **Issue-First Development:** Never work directly on `main`. Always start with `create_issue` ‚Üí `create_branch` ‚Üí `initialize_project`.
2. **Workflow Enforcement:** Always `initialize_project` before work. Use `transition_phase` for progression.
3. **TDD is Non-Negotiable:** If you write code without a test, you are violating protocol.
4. **Tools > Manual:** Never manually create a file if `scaffold_artifact` exists. Never manually parse status if `get_work_context` exists.
5. **English Artifacts, Dutch Chat:** Write Code/Docs/Commits in **English**. Talk to the User in **Dutch** (Nederlands).
6. **Human-in-the-Loop:** PR merge ALWAYS requires human approval. `force_phase_transition` requires approval + reason.
7. **Quality Gates:** Run before phase transitions and before PR creation. Linting 10.00/10 + Type checking Pass.
8. **Type-Checking Consistency:** Resolve typing issues using [docs/coding_standards/TYPE_CHECKING_PLAYBOOK.md](../docs/coding_standards/TYPE_CHECKING_PLAYBOOK.md). No global disables; targeted ignores only as last resort.

---

## üìã Workflow Types

| Workflow | Phases | Use Case |
|----------|--------|----------|
| `feature` | research, planning, design, tdd, integration, documentation | New feature development |
| `bug` | research, planning, design, tdd, integration, documentation | Bug fixes |
| `docs` | planning, documentation | Documentation-only changes |
| `refactor` | research, planning, tdd, integration, documentation | Code refactoring |
| `hotfix` | tdd, integration, documentation | Emergency fixes |
| `epic` | research, planning, design, tdd, integration | Large multi-issue features |
| `custom` | (user-defined) | Custom workflows |

**Workflow Selection:** Use `initialize_project(issue_number, issue_title, workflow_name="feature|bug|docs|...")` to start.

---

## üèóÔ∏è Scaffolding (Always Use Templates)

**NEVER use `safe_edit_file` to create code or documentation from scratch. Always use `scaffold_artifact`.**

| Artifact Type | Use Case | Example |
|---------------|----------|---------|
| `dto` | Data Transfer Objects | `scaffold_artifact(artifact_type="dto", name="UserDTO", context={...})` |
| `worker` | Background processors | `scaffold_artifact(artifact_type="worker", name="ProcessWorker", context={...})` |
| `tool` | MCP tools | `scaffold_artifact(artifact_type="tool", name="MyTool", context={...})` |
| `research` | Research documents | `scaffold_artifact(artifact_type="research", name="my-research", context={...})` |
| `design` | Design documents | `scaffold_artifact(artifact_type="design", name="my-design", context={...})` |
| `reference` | Reference docs | `scaffold_artifact(artifact_type="reference", name="my-reference", context={...})` |

**Registry:** `.st3/artifacts.yaml` defines all artifact types and their templates.

---

## üìö Key Documentation

- **[MCP Tools Reference](../docs/reference/mcp/tools/README.md)** ‚Äî All 46 tools with parameters and examples
- **[TDD Workflow](../docs/coding_standards/TDD_WORKFLOW.md)** ‚Äî TDD cycle details
- **[Quality Gates](../docs/coding_standards/QUALITY_GATES.md)** ‚Äî Validation standards
- **[Git Workflow](../docs/coding_standards/GIT_WORKFLOW.md)** ‚Äî Branch and commit conventions
- **[Agent Protocol (agent.md)](../agent.md)** ‚Äî Extended documentation and examples

---

## ü§ù Agent Cooperation

This project uses **agent handoff** for large tasks:
- Each agent reads these instructions automatically (VS Code auto-injects)
- Fresh context every 50-100K tokens to avoid context pollution
- All agents follow same protocol (consistency)
- Full protocol details in [agent.md](../agent.md)

---

**Remember: These rules are enforced. Violations will be rejected by the user. When in doubt, consult the Tool Priority Matrix or ask the user.**
